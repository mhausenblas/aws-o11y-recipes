
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <meta name="author" content="AWS">
      
      
        <link rel="canonical" href="https://aws-observability.github.io/aws-o11y-recipes/recipes/fargate-eks-metrics-go-adot-ampamg/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.0">
    
    
      
        <title>Using AWS Distro for OpenTelemetry in EKS to ingest metrics into Amazon Managed Service for Prometheus - AWS Observability Recipes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.fe914879.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ba0d045b.min.css">
        
          
          
          <meta name="theme-color" content="#ffa724">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400,400i,700%7CPT+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Lato";--md-code-font-family:"PT Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="orange" data-md-color-accent="blue">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#using-aws-distro-for-opentelemetry-in-eks-to-ingest-metrics-into-amazon-managed-service-for-prometheus" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="AWS Observability Recipes" class="md-header__button md-logo" aria-label="AWS Observability Recipes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M288 256H96v64h192v-64zm89-151L279.1 7c-4.5-4.5-10.6-7-17-7H256v128h128v-6.1c0-6.3-2.5-12.4-7-16.9zm-153 31V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zM64 72c0-4.42 3.58-8 8-8h80c4.42 0 8 3.58 8 8v16c0 4.42-3.58 8-8 8H72c-4.42 0-8-3.58-8-8V72zm0 64c0-4.42 3.58-8 8-8h80c4.42 0 8 3.58 8 8v16c0 4.42-3.58 8-8 8H72c-4.42 0-8-3.58-8-8v-16zm256 304c0 4.42-3.58 8-8 8h-80c-4.42 0-8-3.58-8-8v-16c0-4.42 3.58-8 8-8h80c4.42 0 8 3.58 8 8v16zm0-200v96c0 8.84-7.16 16-16 16H80c-8.84 0-16-7.16-16-16v-96c0-8.84 7.16-16 16-16h224c8.84 0 16 7.16 16 16z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AWS Observability Recipes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Using AWS Distro for OpenTelemetry in EKS to ingest metrics into Amazon Managed Service for Prometheus
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/aws-observability/aws-o11y-recipes/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-observability/aws-o11y-recipes
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        Home
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../eks/" class="md-tabs__link">
        By Compute
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../infra/" class="md-tabs__link">
        By Infra & Databases
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../java/" class="md-tabs__link">
        By Language
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../cw/" class="md-tabs__link">
        By Destination
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../anomaly-detection/" class="md-tabs__link">
        Tasks
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="AWS Observability Recipes" class="md-nav__button md-logo" aria-label="AWS Observability Recipes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M288 256H96v64h192v-64zm89-151L279.1 7c-4.5-4.5-10.6-7-17-7H256v128h128v-6.1c0-6.3-2.5-12.4-7-16.9zm-153 31V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zM64 72c0-4.42 3.58-8 8-8h80c4.42 0 8 3.58 8 8v16c0 4.42-3.58 8-8 8H72c-4.42 0-8-3.58-8-8V72zm0 64c0-4.42 3.58-8 8-8h80c4.42 0 8 3.58 8 8v16c0 4.42-3.58 8-8 8H72c-4.42 0-8-3.58-8-8v-16zm256 304c0 4.42-3.58 8-8 8h-80c-4.42 0-8-3.58-8-8v-16c0-4.42 3.58-8 8-8h80c4.42 0 8 3.58 8 8v16zm0-200v96c0 8.84-7.16 16-16 16H80c-8.84 0-16-7.16-16-16v-96c0-8.84 7.16-16 16-16h224c8.84 0 16 7.16 16 16z"/></svg>

    </a>
    AWS Observability Recipes
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws-observability/aws-o11y-recipes/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-observability/aws-o11y-recipes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      <label class="md-nav__link" for="__nav_1">
        Home
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Home" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Home
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome!
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dimensions/" class="md-nav__link">
        Dimensions
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../telemetry/" class="md-nav__link">
        Telemetry
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        By Compute
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="By Compute" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          By Compute
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../eks/" class="md-nav__link">
        EKS
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ecs/" class="md-nav__link">
        ECS
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../lambda/" class="md-nav__link">
        Lambda
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        By Infra & Databases
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="By Infra & Databases" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          By Infra & Databases
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../infra/" class="md-nav__link">
        Infra
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      <label class="md-nav__link" for="__nav_3_2">
        Databases
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Databases" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Databases
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../rds/" class="md-nav__link">
        RDS
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dynamodb/" class="md-nav__link">
        DynamoDB
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../msk/" class="md-nav__link">
        MSK
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        By Language
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="By Language" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          By Language
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java/" class="md-nav__link">
        Java
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../nodejs/" class="md-nav__link">
        Node.js
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        By Destination
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="By Destination" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          By Destination
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../cw/" class="md-nav__link">
        CW
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../amp/" class="md-nav__link">
        AMP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../amg/" class="md-nav__link">
        AMG
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../aes/" class="md-nav__link">
        AES
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        Tasks
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Tasks" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Tasks
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../anomaly-detection/" class="md-nav__link">
        Anomaly Detection
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../alerting/" class="md-nav__link">
        Alerting
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/" class="md-nav__link">
        Troubleshooting
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../workshops/" class="md-nav__link">
        Workshops
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#infrastructure" class="md-nav__link">
    Infrastructure
  </a>
  
    <nav class="md-nav" aria-label="Infrastructure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-an-eks-cluster" class="md-nav__link">
    Setup an EKS cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-an-ecr-repository" class="md-nav__link">
    Setup an ECR repository
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-amp" class="md-nav__link">
    Setup AMP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-adot-collector" class="md-nav__link">
    Setup ADOT Collector
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-amg" class="md-nav__link">
    Setup AMG
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#application" class="md-nav__link">
    Application
  </a>
  
    <nav class="md-nav" aria-label="Application">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#build" class="md-nav__link">
    Build
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#push" class="md-nav__link">
    Push
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy" class="md-nav__link">
    Deploy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#end-to-end" class="md-nav__link">
    End-to-end
  </a>
  
    <nav class="md-nav" aria-label="End-to-end">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#verify-your-pipeline-is-working" class="md-nav__link">
    Verify your pipeline is working
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-grafana-dashboard-in-amg" class="md-nav__link">
    Create a Grafana dashboard in AMG
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cleanup" class="md-nav__link">
    Cleanup
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-observability/aws-o11y-recipes/edit/master/docs/recipes/fargate-eks-metrics-go-adot-ampamg.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="using-aws-distro-for-opentelemetry-in-eks-to-ingest-metrics-into-amazon-managed-service-for-prometheus">Using AWS Distro for OpenTelemetry in EKS to ingest metrics into Amazon Managed Service for Prometheus<a class="headerlink" href="#using-aws-distro-for-opentelemetry-in-eks-to-ingest-metrics-into-amazon-managed-service-for-prometheus" title="Permanent link">&para;</a></h1>
<p>In this recipe we show you how to instrument a <a href="https://github.com/aws-observability/aws-otel-community/tree/master/sample-apps/prometheus">sample Go application</a> and
use <a href="https://aws.amazon.com/otel">AWS Distro for OpenTelemetry (ADOT)</a> to ingest metrics into
<a href="https://aws.amazon.com/prometheus/">Amazon Managed Service for Prometheus (AMP)</a> .
Then we're using <a href="https://aws.amazon.com/grafana/">Amazon Managed Service for Grafana (AMG)</a> to visualize the metrics.</p>
<p>We will be setting up an <a href="https://aws.amazon.com/eks/">Amazon Elastic Kubernetes Service (EKS)</a> cluster and <a href="https://aws.amazon.com/ecr/">Amazon Elastic Container Registry (ECR)</a> repository to demonstrate a complete scenario.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This guide will take approximately 1 hour to complete.</p>
</div>
<h2 id="infrastructure">Infrastructure<a class="headerlink" href="#infrastructure" title="Permanent link">&para;</a></h2>
<p>In the following section we will be setting up the infrastructure for this recipe. </p>
<h3 id="architecture">Architecture<a class="headerlink" href="#architecture" title="Permanent link">&para;</a></h3>
<p>The ADOT-AMP pipeline enables us to use the <a href="https://github.com/aws-observability/aws-otel-collector">ADOT Collector</a> to scrape a Prometheus-instrumented application, and send the scraped metrics to AMP. </p>
<p><img alt="Architecture" src="https://aws-otel.github.io/static/Prometheus_Pipeline-07344e5466b05299cff41d09a603e479.png" /></p>
<p>The ADOT Collector includes two AWS OpenTelemetry Collector components specific to Prometheus — the Prometheus Receiver and the AWS Prometheus Remote Write Exporter. </p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>For more information on Prometheus Remote Write Exporter check out:
<a href="https://aws-otel.github.io/docs/getting-started/prometheus-remote-write-exporter">Getting Started with Prometheus Remote Write Exporter for AMP</a></p>
</div>
<h3 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">&para;</a></h3>
<ul>
<li>The AWS CLI is <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html">installed</a> and <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html">configured</a> in your environment.</li>
<li>You need to install the <a href="https://docs.aws.amazon.com/eks/latest/userguide/eksctl.html">eksctl</a> command in your environment.</li>
<li>You need to install <a href="https://docs.aws.amazon.com/eks/latest/userguide/install-kubectl.html">kubectl</a> in your environment. </li>
<li>You have <a href="https://docs.docker.com/get-docker/">docker</a> installed into your environment.</li>
</ul>
<h3 id="setup-an-eks-cluster">Setup an EKS cluster<a class="headerlink" href="#setup-an-eks-cluster" title="Permanent link">&para;</a></h3>
<p>Our demo application in this recipe will be running on top of EKS. 
You can either use an existing EKS cluster or create one using <a href="../ec2-eks-metrics-go-adot-ampamg/cluster-config.yaml">cluster_config.yaml</a>.</p>
<p>This template will create a new cluster with EKS on <a href="https://aws.amazon.com/fargate/">AWS Fargate</a>. </p>
<p>Edit the template file and set your region to one of the available regions for AMP:</p>
<ul>
<li><code>us-east-1</code></li>
<li><code>us-east-2</code></li>
<li><code>us-west-2</code></li>
<li><code>eu-central-1</code></li>
<li><code>eu-west-1</code></li>
</ul>
<p>Make sure to overwrite this region in your session, for example in bash:
<div class="highlight"><pre><span></span><code>export AWS_DEFAULT_REGION=eu-west-1
</code></pre></div></p>
<p>Create your cluster using the following command.
<div class="highlight"><pre><span></span><code>eksctl create cluster -f cluster-config.yaml
</code></pre></div></p>
<h3 id="setup-an-ecr-repository">Setup an ECR repository<a class="headerlink" href="#setup-an-ecr-repository" title="Permanent link">&para;</a></h3>
<p>In order to deploy our application to EKS we need a container registry. 
You can use the following command to create a new ECR registry in your account. </p>
<div class="highlight"><pre><span></span><code>aws ecr create-repository \
    --repository-name prometheus-sample-app \
    --image-scanning-configuration scanOnPush=true \
    --region eu-west-1
</code></pre></div>
<h3 id="setup-amp">Setup AMP<a class="headerlink" href="#setup-amp" title="Permanent link">&para;</a></h3>
<p>create a workspace using the AWS CLI 
<div class="highlight"><pre><span></span><code>aws amp create-workspace --alias prometheus-sample-app
</code></pre></div></p>
<p>Verify the workspace is created using:
<div class="highlight"><pre><span></span><code>aws amp list-workspaces
</code></pre></div></p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>For more details check out the <a href="https://docs.aws.amazon.com/prometheus/latest/userguide/AMP-getting-started.html">AMP Getting started</a> guide.</p>
</div>
<h3 id="setup-adot-collector">Setup ADOT Collector<a class="headerlink" href="#setup-adot-collector" title="Permanent link">&para;</a></h3>
<p>Download the template file <a href="./ec2-eks-metrics-go-adot-ampamg/prometheus-fargate.yaml">prometheus-fargate.yaml</a> and edit this file with the parameters described in the next steps.</p>
<p>In this example, the ADOT Collector configuration uses an annotation <code>(scrape=true)</code> to tell which target endpoints to scrape. This allows the ADOT Collector to distinguish the sample app endpoint from kube-system endpoints in your cluster. You can remove this from the re-label configurations if you want to scrape a different sample app. </p>
<p>Use the following steps to edit the downloaded file for your environment:</p>
<p>1. Replace <code>&lt;REGION&gt;</code> with your current Region. </p>
<p>2. Replace <code>&lt;YOUR_ENDPOINT&gt;</code>  with your AMP workspace endpoint URL.</p>
<p>Get your AMP endpoint url by executing the following query:
<div class="highlight"><pre><span></span><code>aws amp describe-workspace \ 
    --workspace-id `aws amp list-workspaces --alias prometheus-sample-app --query &#39;workspaces[0].workspaceId&#39; --output text` \
    --query &#39;workspace.prometheusEndpoint&#39;
</code></pre></div></p>
<p>3. Finally replace your <code>&lt;YOUR_ACCOUNT_ID&gt;</code>  with your current account ID.</p>
<p>The following command will return the account ID for the current session:
<div class="highlight"><pre><span></span><code>aws sts get-caller-identity --query Account --output text
</code></pre></div></p>
<p>After creating deployment file we can now apply this to our cluster by using the following command: </p>
<div class="highlight"><pre><span></span><code>kubectl apply -f prometheus-fargate.yaml
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>For more information check out the <a href="https://aws-otel.github.io/docs/getting-started/prometheus-remote-write-exporter/eks#aws-distro-for-opentelemetry-adot-collector-setup">AWS Distro for OpenTelemetry (ADOT) Collector Setup</a></p>
</div>
<h3 id="setup-amg">Setup AMG<a class="headerlink" href="#setup-amg" title="Permanent link">&para;</a></h3>
<p>Setup a new AMG workspace using the <a href="https://aws.amazon.com/blogs/mt/amazon-managed-grafana-getting-started/">Amazon Managed Service for Grafana – Getting Started</a> guide.</p>
<p>Make sure to add "Amazon Managed Service for Prometheus" as a datasource during creation.</p>
<p><img alt="Service managed permission settings" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2020/12/09/image008-1024x870.jpg" /></p>
<h2 id="application">Application<a class="headerlink" href="#application" title="Permanent link">&para;</a></h2>
<p>In this recipe we will be using a <a href="https://github.com/aws-observability/aws-otel-community/tree/master/sample-apps/prometheus">sample application</a> from the AWS Observability repository.</p>
<p>This Prometheus sample app generates all four Prometheus metric types (counter, gauge, histogram, summary) and exposes them at the <code>/metrics</code>endpoint.</p>
<h3 id="build">Build<a class="headerlink" href="#build" title="Permanent link">&para;</a></h3>
<p>Clone the following Git repository
<div class="highlight"><pre><span></span><code>git clone git@github.com:aws-observability/aws-otel-community.git
</code></pre></div></p>
<p>Build the container
<div class="highlight"><pre><span></span><code>cd ./aws-otel-community/sample-apps/prometheus
docker build . -t prometheus-sample-app:latest
</code></pre></div></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If go mod fails in your environment due to a proxy.golang.or i/o timeout,
you are able to bypass the go mod proxy by editing the Dockerfile.</p>
<p>Change the following line in the Docker file:
<div class="highlight"><pre><span></span><code>RUN GO111MODULE=on go mod download
</code></pre></div>
to:
<div class="highlight"><pre><span></span><code>RUN GOPROXY=direct GO111MODULE=on go mod download
</code></pre></div></p>
</div>
<h3 id="push">Push<a class="headerlink" href="#push" title="Permanent link">&para;</a></h3>
<p>Change the region variable to the region you selected in the beginning of this guide:
<div class="highlight"><pre><span></span><code>export REGION=&quot;eu-west-1&quot;
export ACCOUNTID=`aws sts get-caller-identity --query Account --output text`
</code></pre></div></p>
<p>Authenticate to your default registry:
<div class="highlight"><pre><span></span><code>aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin &quot;$ACCOUNTID.dkr.ecr.$REGION.amazonaws.com&quot;
</code></pre></div></p>
<p>Push container to the ECR repository
<div class="highlight"><pre><span></span><code>docker tag prometheus-sample-app:latest &quot;$ACCOUNTID.dkr.ecr.$REGION.amazonaws.com/prometheus-sample-app:latest&quot;
docker push &quot;$ACCOUNTID.dkr.ecr.$REGION.amazonaws.com/prometheus-sample-app:latest&quot;
</code></pre></div></p>
<h3 id="deploy">Deploy<a class="headerlink" href="#deploy" title="Permanent link">&para;</a></h3>
<p>Edit <code>prometheus-sample-app.yaml</code> to contain your ECR image path.</p>
<p>-&gt; show line here.</p>
<p>Deploy the sample app to your cluster:
<div class="highlight"><pre><span></span><code>kubectl apply -f prometheus-sample-app.yaml
</code></pre></div></p>
<h2 id="end-to-end">End-to-end<a class="headerlink" href="#end-to-end" title="Permanent link">&para;</a></h2>
<p>Now that you have the infrastructure and the application in place, we will test out the setup, sending metrics from the Go app running in EKS to AMP and visualize it in AMG.</p>
<h3 id="verify-your-pipeline-is-working">Verify your pipeline is working<a class="headerlink" href="#verify-your-pipeline-is-working" title="Permanent link">&para;</a></h3>
<p>Enter the following command to and note down the name of the collector pod:</p>
<div class="highlight"><pre><span></span><code>kubectl -n adot-col get pods 
</code></pre></div>
<p>You should be able to see a adot-collector pod in the running state:
<div class="highlight"><pre><span></span><code>NAME                              READY   STATUS    RESTARTS   AGE
adot-collector-5f7448f6f6-cj7j8   1/1     Running   0          1h
</code></pre></div></p>
<p>Our example template is already integrated with the logging exporter. Enter the following command:</p>
<div class="highlight"><pre><span></span><code>kubectl -n adot-col logs adot-collector
</code></pre></div>
<p>From  of the scraped metrics from the sample app will look like the following example: 
<div class="highlight"><pre><span></span><code>Resource labels:
     -&gt; service.name: STRING(kubernetes-service-endpoints)
     -&gt; host.name: STRING(192.168.16.238)
     -&gt; port: STRING(8080)
     -&gt; scheme: STRING(http)
InstrumentationLibraryMetrics #0
Metric #0
Descriptor:
     -&gt; Name: test_gauge0
     -&gt; Description: This is my gauge
     -&gt; Unit: 
     -&gt; DataType: DoubleGauge
DoubleDataPoints #0
StartTime: 0
Timestamp: 1606511460471000000
Value: 0.000000
</code></pre></div></p>
<p>To test whether AMP received the metrics, use <a href="https://github.com/okigan/awscurl">awscurl</a>. This tool enables you to send HTTP requests through the command line with AWS Sigv4 authentication, so you must have AWS credentials set up locally with the correct permissions to query from AMP.</p>
<p>In the following command, and replace <code>$AMP_ENDPOINT</code> with the endpoint for your AMP workspace. </p>
<div class="highlight"><pre><span></span><code>awscurl --service=&quot;aps&quot; \ 
    --region=&quot;$REGION&quot; &quot;https://$AMP_ENDPOINT/api/v1/query?query=adot_test_gauge0&quot; \
        {&quot;status&quot;:&quot;success&quot;,&quot;data&quot;:{&quot;resultType&quot;:&quot;vector&quot;,&quot;result&quot;:[{&quot;metric&quot;:{&quot;__name__&quot;:&quot;adot_test_gauge0&quot;},&quot;value&quot;:[1606512592.493,&quot;16.87214000011479&quot;]}]}}
</code></pre></div>
<h3 id="create-a-grafana-dashboard-in-amg">Create a Grafana dashboard in AMG<a class="headerlink" href="#create-a-grafana-dashboard-in-amg" title="Permanent link">&para;</a></h3>
<p>Use the following guides to create your first dashboard:</p>
<ul>
<li><a href="https://docs.aws.amazon.com/grafana/latest/userguide/dashboard-overview.html">User Guide: Dashboards</a></li>
<li><a href="https://grafana.com/docs/grafana/latest/best-practices/best-practices-for-creating-dashboards/">Best practices for creating dashboards</a></li>
</ul>
<p>-&gt; Put more content here.</p>
<p><img alt="placeholder-image" src="https://d1.awsstatic.com/products/grafana/amg-console-1.a9bcc3ab4dc86a378eb808851f54cee8a34cb300.png" /></p>
<h2 id="cleanup">Cleanup<a class="headerlink" href="#cleanup" title="Permanent link">&para;</a></h2>
<ol>
<li>Remove the resources and cluster
<div class="highlight"><pre><span></span><code>kubectl delete all --all
eksctl delete cluster --name amp-eks-fargate
</code></pre></div></li>
<li>Remove the AMP workspace
<div class="highlight"><pre><span></span><code>aws amp delete-workspace --workspace-id `aws amp list-workspaces --alias prometheus-sample-app --query &#39;workspaces[0].workspaceId&#39; --output text`
</code></pre></div></li>
<li>Remove the amp-iamproxy-ingest-role IAM role 
<div class="highlight"><pre><span></span><code>aws delete-role --role-name amp-iamproxy-ingest-role
</code></pre></div></li>
<li>Remove the AMG workspace by removing it from the console. </li>
</ol>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; Amazon 2021 
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tabs"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.53c85856.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.716f8af4.min.js"></script>
      
    
  </body>
</html>